/*******************************************************************
 * File:        lowfile_c
 * Purpose:     'lowfile', but in C for cross platform use
 * Author:      Gerph
 * Date:        15 Dec 2025
 ******************************************************************/

#include <string.h>
#include <stdio.h>

#ifdef __riscos
#include "swis.h"
#endif

#include "lowfile.h"

//#define DEBUGTHIS

#ifdef DEBUGTHIS
#define dprintf if (1) printf
#else
#define dprintf if (0) printf
#endif


#define NHANDLES (32)
#define MINHANDLE (3)

static char *opentab[] = { "rb", "wb", "r+b" };

static int riscosio_needinit = 1;
static FILE *handles[NHANDLES];

#define FD_STDIN  (0)
#define FD_STDOUT (1)
#define FD_STDERR (2)

#define SETUP if (riscosio_needinit) setup_riscosio()
#define CHECK(fd, fail) \
    do { \
       if (fd < 0 || fd >= NHANDLES || \
           handles[fd] == NULL) \
       { \
         dprintf("CHECK(%i) invalid handle %p\n", fd, handles[fd]); \
         return fail; \
       } \
       fh = handles[fd]; \
    } while (0)

static void setup_riscosio(void)
{
    int i;

    dprintf("setup_riscosio\n");

    for (i = 0; i < NHANDLES; ++i)
        handles[i] = NULL;
    handles[FD_STDIN] = stdin;
    handles[FD_STDOUT] = stdout;
    handles[FD_STDERR] = stderr;
    riscosio_needinit = 0;
}

int low_open(char *name, int flags)
{
    FILE *fh;
    int mode = 0;

    SETUP;

    if ((flags & 0xC0) == low_UPDATE)
        mode = 2;
    else if ((flags & 0xC0) == low_CREATE)
        mode = 1;
    else if ((flags & 0xC0) == low_READ)
        mode = 0;

    dprintf("low_open('%s', %i) => mode %s\n", name, flags, opentab[mode]);
    fh = fopen(name, opentab[mode]);
    if (fh == NULL)
        return 0;

    {
        /* Find a handle */
        int fd;
        for (fd = MINHANDLE; fd < NHANDLES; fd++)
        {
            if (handles[fd] == NULL)
                break;
        }
        if (fd == NHANDLES)
        {
            fclose(fh);
            return 0;           /* No free handles */
        }
        handles[fd] = fh;
        dprintf("  = %i (%p)\n", fd, fh);
        return fd;
    }
}


void low_close(int fd)
{
    FILE *fh;
    SETUP;
    CHECK(fd,);
    fclose(fh);
    handles[fd] = NULL;
    return;
}

int low_eof(int fd)
{
    FILE *fh;

    SETUP;
    CHECK(fd, -1);
    return feof(fh);
}


int low_read(int fd, void *buf, int len)
{
    FILE *fh;
    int nread;

    dprintf("low_read(%i, %p, %i)\n", fd, buf, len);
    SETUP;
    CHECK(fd, 0);
    if (fh == stdin)
    {
        if (fgets(buf, len, stdin) == NULL)
            nread = 0;
        else
            nread = strlen(buf);
    }
    else
    {
        nread = (int)fread(buf, (size_t) 1, (size_t) len, fh);
    }
    dprintf("Read %i from %p\n", nread, fh);

    if (ferror(fh))
        return 0;
    else
        return nread;
}


void low_write(int fd, void *buf, int len)
{
    FILE *fh;
    int written;

    SETUP;
    CHECK(fd,);
    written = (int)fwrite(buf, (size_t) 1, (size_t) len, fh);
}



int low_ptr(int fd)
{
    FILE *fh;
    long pos;

    SETUP;
    CHECK(fd, -1);
    pos = ftell(fh);
    return (int) pos;
}


void low_setptr(int fd, int ptr)
{
    FILE *fh;

    SETUP;
    CHECK(fd,);
    fseek(fh, ptr, SEEK_SET);
}


int low_extent(int fd)
{
    FILE *fh;
    long cur;
    long pos;

    dprintf("low_extent(%i) : fh=%p\n", fd, (fd >=0 && fd < NHANDLES) ? handles[fd] : NULL);
    SETUP;
    CHECK(fd, -1);
    cur = ftell(fh);
    fseek(fh, 0, SEEK_END);
    pos = ftell(fh);
    fseek(fh, cur, SEEK_SET);

    dprintf("  = %li\n", pos);

    return (int) pos;
}

int save_file(char *filename, void *address, int nbytes, int filetype)
{
#ifdef __riscos
    _kernel_oserror *err = _swix(OS_File, _INR(0, 5), 10, filename, filetype, 0, address, ((char *) address) + nbytes);
    if (err)
        return -1;
    return 0;
#else
    char newfilename[256];
    FILE *fh;

    if (filetype != 0xFFF && filetype != -1)
        sprintf(newfilename, "%s,%03x", filename, filetype);
    else
        strcpy(newfilename, filename);
    fh = fopen(newfilename, "wb");
    if (fh == NULL)
        return -1;
    fwrite(address, 1, nbytes, fh);
    fclose(fh);
    return 0;
#endif
}
